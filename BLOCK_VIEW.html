<!DOCTYPE html>
<html style="width:100%;height:100%;">
	<head>
		<meta charset="utf-8" />
		<title>"BLOCK VIEW"</title>
        <script src="libraries/FileSaver.js" type="text/javascript"></script>
	    <script src="libraries/spectrum.js"></script>
	    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="Species_Details.json"></script>
		<script src="Blocks.json"></script>
    	<link rel="stylesheet" type="text/css" href="libraries/spectrum.css">
    <style>
/* 		Colors: Black #272727 grey #747474 orage #FF652F yellow #FFE400 green #14a76C */
		
	/* Header details */
	
			.header {overflow: hidden;background-color: #404040;padding: 20px 10px; }
			.header a {float: left;text-align: center;padding: 12px;text-decoration: none;font-size: 18px; line-height: 25px;border-radius: 4px;color: #e6e6e6;}
			.header-right {float: right;}
			.header-center {font-size: 22px;text-align: center; line-height: 25px;border-radius: 4px;color: #e6e6e6;}

			.header a.logo {font-size: 25px;font-weight: bold;color: #99bbff;}	
/* Details for the box */
.Block_container {position: relative; width: 100%; height: 800px;overflow: scroll; }
.Data_container{padding: 30px 30px;position: relative; width: 90%; height: 200px;overflow: scroll;}
.output_data{padding: 30px 30px;height:80px;background-color: white;overflow: scroll;}
.container-l {
  float: left;
  width: 46%;
  height: 350px;
  background-color: rgb(230, 230, 233);
  padding: 20px 10px;
  box-shadow: 2px 2px 2px 0px rgba(0, 0, 0, 0.1), 0 4px 4px 0 rgba(0, 0, 0, 0.15);
}
.container-r {
  float: right;
  width: 46%;
  height: 350px;
  background-color: rgb(230, 230, 233);
  padding: 20px 10px;
  box-shadow: 2px 2px 2px 0px rgba(0, 0, 0, 0.1), 0 4px 4px 0 rgba(0, 0, 0, 0.15);
}

.selecthead {
  text-align: center;
  font-size: 20px;
  font-weight: 600;
  font-family: 'Open Sans', sans-serif;
  color: rgb(116, 124, 142);
  padding: 10px 0px 0px 40px;
}

.box {
height: 300px;
  padding: 20px 10px;
  color: rgb(116, 124, 142);
  font-size: 15px;
  overflow: auto;
}

.chrcontain {
  position: relative;
  width: 100%;
  height: 340px;
  overflow-y: scroll;
}

.que-button-not-selected {background-color: #000000;width:100%;border: none; height=10px;color: white;padding: 10px 10px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;margin: 4px 2px;cursor: pointer;outline:0;}
.que-button-selected {background-color: #800000;width:100%;border: none; height=10px;color: white;padding: 10px 10px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;margin: 4px 2px;cursor: pointer;outline:0;}

.ref-button-not-selected {background-color: #000000;width:100%;border: none; height=10px;color: white;padding: 10px 10px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;margin: 4px 2px;cursor: pointer;outline:0;}
.ref-button-selected {background-color: #4CAF50;width:100%;border: none; height=10px;color: white;padding: 10px 10px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;margin: 4px 2px;cursor: pointer;outline:0;}
.button-hover {background-color: white;width:100%;border: none; height=10px;color: black;padding: 10px 10px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;margin: 4px 2px;cursor: pointer;outline:0;}
.rangeslider{
    width: 50%;
    }

/* Mobile and narrow window */
			@media screen and (max-width: 500px) {
				.header a {float: none;display: block;text-align: left;}
				.header-right {float: none;}
				.reftreedet{float: none;border:0px solid #FFE400;}
				.comtreedet{float: none;border:0px solid #FFE400;}
			}	
		</style>
		</head>
	<body style="width:100%;height:100%;margin:0;background-color: #404040;">
   
<!--    This section presents all of the header details. Woop Woop. -->
		<div class="header" id = "Title">
 		 <a href="#default" class="logo">Evolution Highway</a>
 		 <div class="header-center" id="TITLE">
 		 
 		 </div>
 			 <div class="header-right">
   			 <a class="active" href="#home">Help</a>
  			  <a href="https://www.rvc.ac.uk/about/our-people/denis-larkin#tab-research">About Our Lab</a>
  			</div>
     	</div>
     	

<div id="Blocks_Box" class="Block_container" style="background-color: #FFFFFF;">
	<svg id="BLOCKS_VIEW" width=1500 height=1000 xmlns="http://www.w3.org/2000/svg"  xmlns:xlink="http://www.w3.org/1999/xlink" >
	</svg>
</div>

<button onclick="save_svg()" class="button1">
	Save Graphic as SVG
</button>
<button onclick="save_csv()" class="button1">
	Save selected data as CSV
</button>

<div class="slidecontainer">
	Chromosome Width
  <input type="range" min="25" max="200" value="50" class="slider" id="widthslider">

	Chromosome Length
  <input type="range" min="200" max="10000" value="1000" class="slider" id="lengthslider">
</div>
<br>
<div>
Chromosome Color   <input type='color' id="Chr_Color" value="#ffffcc" />Forward Color  <input type='color' id="Fwd_Color" value="#000099" />Reverse Color  <input type='color' id="Rvs_Color" value="#cc0000" />Reverse Highlight  <input type='color' id="Rvs_Hlt" value="#ff9933" />Forward Highlight  <input type='color' id="Fwd_Hlt" value="#33cc33" />Label Text  <input type='color' id="Lbl_clr" value="#FFFFFF" />Label Size  <input type='text' id="Lbl_sze" value="Responsive" />Label Shadow  <input type='checkbox' id="Lbl_sdw" checked="checked" />Chromosome Selection  <input type='checkbox' id="Chr_Sel" checked="checked" />Scale  <input type='checkbox' id="Scl" checked="checked" />
</div>

</div class="Data_container">   
    <div id="SELECTED_BLOCKS" class="output_data">
</div>





<script>
var svgNS = "http://www.w3.org/2000/svg";  

// Input variables
var Chromosomes=[];
var Genome_Name="";
var Blocks=[];
var Que_Genomes=[];
var Block_Array=[];
var SELECT_ALL_THING=[];
// Chosen cooridinates
var Selected=[];
// csv output
var CSV_output;

// Modifiable Paramaters
// Set the width of the chromosomes
var SET_WIDTH=50;// Default width of chromsome
var rangeslider = document.getElementById("widthslider");
rangeslider.oninput = function() {
	SET_WIDTH=this.value;
	make_SVG();

}
var SET_Length=1000;// Default length of chromsome
var rangeslider = document.getElementById("lengthslider");
rangeslider.oninput = function() {
	SET_Length=this.value;
	make_SVG();
}
// Set the color of the chromosomes

var CHR_COLOR="#ffffcc";
var color = document.getElementById("Chr_Color");
color.oninput = function() {
	CHR_COLOR=this.value;
	make_SVG();
}
var FORWARD_COLOR="#000099";
var color = document.getElementById("Fwd_Color");
color.oninput = function() {
	FORWARD_COLOR=this.value;
	make_SVG();
}
var REVERSE_COLOR="#cc0000";
var color = document.getElementById("Rvs_Color");
color.oninput = function() {
	REVERSE_COLOR=this.value;
	make_SVG();
}
var FORWARD_HIGHLIGHT="#33cc33";
var color = document.getElementById("Fwd_Hlt");
color.oninput = function() {
	FORWARD_HIGHLIGHT=this.value;
	make_SVG();
}
var REVERSE_HIGHLIGHT="#ff9933";
var color = document.getElementById("Rvs_Hlt");
color.oninput = function() {
	REVERSE_HIGHLIGHT=this.value;
	make_SVG();
}
var LABEL_COLOR="#FFFFFF";
var color = document.getElementById("Lbl_clr");
color.onchange = function() {
	LABEL_COLOR=this.value;
	make_SVG();
}
var LABEL_FONT_SIZE="Responsive";
var fontsizer = document.getElementById("Lbl_sze");
fontsizer.onkeyup = function() {
	LABEL_FONT_SIZE=fontsizer.value;
	console.log(LABEL_FONT_SIZE);
	make_SVG();
}
var LABEL_SHADOW=true;
var shadowlabel = document.getElementById("Lbl_sdw");
	shadowlabel.onclick = function() {
	console.log("fuck ya");
	LABEL_SHADOW=shadowlabel.checked;
		make_SVG();
}
// <input type='checkbox' id="Chr_Sel" checked="checked" />
var SELECT_ALL_BUTTON=true;
var Label = document.getElementById("Chr_Sel");
	Label.onclick = function() {
	SELECT_ALL_BUTTON=Label.checked;
		make_SVG();
}

Scl
// <input type='checkbox' id="Chr_Sel" checked="checked" />
var SCALE_BUTTON=true;
var SCL = document.getElementById("Scl");
	SCL.onclick = function() {
	SCALE_BUTTON=SCL.checked;
		make_SVG();
}

// Label Shadow  <input type='checkbox' id="Lbl_sdw" checked="checked" />

//For saving to file
function save_svg(){
	var svg_data = document.getElementById("BLOCKS_VIEW").innerHTML //put id of your svg element here
	var head = '<svg title="graph" version="1.1" xmlns="http://www.w3.org/2000/svg">'
	//if you have some additional styling like graph edges put them inside <style> tag
	var style = '<style>circle {cursor: pointer;stroke-width: 1.5px;}text {font: 10px arial;}path {stroke: DimGrey;stroke-width: 1.5px;}</style>'
	var full_svg = head +  style + svg_data + "</svg>"
	var blob = new Blob([full_svg], {type: "image/svg+xml"});  
	saveAs(blob, "Blocks.svg");
};

// for getting actual cooridinates
 var svg = document.getElementById('BLOCKS_VIEW');
function svgPoint(element, x, y) {
  var pt = svg.createSVGPoint();
  pt.x = x;
  pt.y = y;
  return pt.matrixTransform(element.getScreenCTM().inverse());
}




function make_SVG(){

// CLEAR WINDOW
	const tempnode=document.getElementById("BLOCKS_VIEW");
  	while (tempnode.firstChild) {
    		tempnode.removeChild(tempnode.firstChild);
  	}	



// Calculate Max Length to fit into viewbox
	var CONVERSION=1;
// 	var testbox=document.getElementById("BLOCKS_VIEW").getAttribute("viewBox").split(" ");
	var longest;
	for (var i = 0; i < Chromosomes.length; i++) {
		if (parseInt(Chromosomes[i].ChrLength)>parseInt(CONVERSION)){
			CONVERSION=Chromosomes[i].ChrLength;
			longest=Chromosomes[i].ChrLength;
		}
	}

	CONVERSION=CONVERSION/(parseInt(SET_Length));
	document.getElementById("BLOCKS_VIEW").setAttributeNS(null,"height",(parseInt(SET_Length))+450);

// 	Calculate the total number of chromsome pairs to draw _ along with the width.
	WIDTH=((Chromosomes.length*Que_Genome.length)+(Chromosomes.length-1)+2)*SET_WIDTH;
	document.getElementById("BLOCKS_VIEW").setAttributeNS(null,"width",WIDTH+400);

//  	console.log("Chromosomes" + JSON.stringify(Chromosomes));
//  	console.log("Genome_Name" + Genome_Name);
//   	console.log("Blocks" + JSON.stringify(Blocks));
//    	console.log("Que_Genome" + Que_Genome);



// #####################
// ##################### ADD GENOME NAME LOOKUP!!!!
// #####################

// Make title
var titlefound=false;
var title;
Species_details.forEach(function (arrayItem) {
// 						console.log(arrayItem);
	if (arrayItem.Taxid ==Genome_Name){
		title=arrayItem.Name + " chromosome comparison"
		document.getElementById("TITLE").innerHTML=title;
		 titlefound=true;

		}
	});					
	if (titlefound==false){
		title==Genome_Name + " chromosome comparison";
		document.getElementById("TITLE").innerHTML=Genome_Name + " chromosome comparison";
	}
//  		place it at the bottom
 		mytext = document.createElementNS(svgNS,"text"); 
            	mytext.setAttributeNS(null,"x",SET_WIDTH);
       		 	mytext.setAttributeNS(null,"y",(parseInt(SET_Length, 10)+400));
       		 	mytext.setAttributeNS(null,"font-size","25px");       		 	
            	mytext.innerHTML = title;
            	document.getElementById("BLOCKS_VIEW").appendChild(mytext); 


	// ADD LATER: SORT BY SIZE


// ADD SIZE SCALE

	if (SCALE_BUTTON==true){
// 	Draw mbp labels
	var mytext = document.createElementNS(svgNS,"text"); 
		mytext.setAttributeNS(null,"x",(WIDTH-0.6*SET_WIDTH));
		 mytext.setAttributeNS(null,"y",100);
		 mytext.setAttributeNS(null,"alignment-baseline","middle");
		 mytext.setAttributeNS(null,"font-size","14px");    
		mytext.innerHTML = "MBP";
		document.getElementById("BLOCKS_VIEW").appendChild(mytext);
		
			var mytext = document.createElementNS(svgNS,"text"); 
		mytext.setAttributeNS(null,"x",(0.6*SET_WIDTH));
		 mytext.setAttributeNS(null,"y",100);
		 mytext.setAttributeNS(null,"alignment-baseline","middle");
		 mytext.setAttributeNS(null,"font-size","14px");    
		 mytext.setAttributeNS(null,"text-anchor","end");       		 	

		mytext.innerHTML = "MBP";
		document.getElementById("BLOCKS_VIEW").appendChild(mytext);  
		
		
		
// 	
// 		DRAW TOP =SOLID black

	myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
	myline.setAttributeNS(null,"x1",0.8*SET_WIDTH);
	myline.setAttributeNS(null,"x2",WIDTH-0.8*SET_WIDTH);
	myline.setAttributeNS(null,"y1",100);
	myline.setAttributeNS(null,"y2",100);
	myline.setAttributeNS(null,"stroke","black");
	myline.setAttributeNS(null,"stroke-width",1);
	document.getElementById("BLOCKS_VIEW").appendChild(myline);	
// Draw bottom
	myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
	myline.setAttributeNS(null,"x1",0.8*SET_WIDTH);
	myline.setAttributeNS(null,"x2",WIDTH-0.8*SET_WIDTH);
	myline.setAttributeNS(null,"y1",(parseInt(SET_Length, 10)+350));
	myline.setAttributeNS(null,"y2",(parseInt(SET_Length, 10)+350));
	myline.setAttributeNS(null,"stroke","black");
	myline.setAttributeNS(null,"stroke-width",1);
	document.getElementById("BLOCKS_VIEW").appendChild(myline);	


// Draw Axis left
	myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
	myline.setAttributeNS(null,"x1",0.8*SET_WIDTH);
	myline.setAttributeNS(null,"x2",0.8*SET_WIDTH);
	myline.setAttributeNS(null,"y1",100);
	myline.setAttributeNS(null,"y2",(parseInt(SET_Length, 10)+350));
	myline.setAttributeNS(null,"stroke","black");
	myline.setAttributeNS(null,"stroke-width",1);
	document.getElementById("BLOCKS_VIEW").appendChild(myline);	


// Draw Axis Right
	myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
	myline.setAttributeNS(null,"x1",WIDTH-0.8*SET_WIDTH);
	myline.setAttributeNS(null,"x2",WIDTH-0.8*SET_WIDTH);
	myline.setAttributeNS(null,"y1",100);
	myline.setAttributeNS(null,"y2",(parseInt(SET_Length, 10)+350));
	myline.setAttributeNS(null,"stroke","black");
	myline.setAttributeNS(null,"stroke-width",1);
	document.getElementById("BLOCKS_VIEW").appendChild(myline);	
	// 		DRAW end of each Chromsome =SOLID GREY
	for (var i = 0; i < Chromosomes.length; i++) {
		myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
		myline.setAttributeNS(null,"x1",0.8*SET_WIDTH);
		myline.setAttributeNS(null,"x2",WIDTH-0.8*SET_WIDTH);
		myline.setAttributeNS(null,"y1",(Chromosomes[i].ChrLength/CONVERSION+100));
		myline.setAttributeNS(null,"y2",(Chromosomes[i].ChrLength/CONVERSION+100));
		myline.setAttributeNS(null,"stroke","#C0C0C0");
		myline.setAttributeNS(null,"stroke-width",1);
		document.getElementById("BLOCKS_VIEW").appendChild(myline);		
	}
// 	Draw extremly light line every 1mbp.
	if (CONVERSION<150000){
		for (var i = 0; i < (longest/CONVERSION+250); i=i+1000000/CONVERSION) {
			myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
			myline.setAttributeNS(null,"x1",0.8*SET_WIDTH);
			myline.setAttributeNS(null,"x2",WIDTH-0.8*SET_WIDTH);
			myline.setAttributeNS(null,"y1",i+100);
			myline.setAttributeNS(null,"y2",i+100);
			myline.setAttributeNS(null,"stroke","#DCDCDC");
			myline.setAttributeNS(null,"stroke-width",1);
			myline.setAttributeNS(null,"stroke-dasharray","1 1");
			document.getElementById("BLOCKS_VIEW").appendChild(myline);		
		}
	}

// 	DRAW dashed line for 5mb (super light) and darker for 10mbp and ticks for them.
	if (CONVERSION<300000){
		var COUNTER=0;
		for (var i = 0; i < (longest/CONVERSION+250); i=i+5000000/CONVERSION) {
			myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
			myline.setAttributeNS(null,"x1",0.8*SET_WIDTH);
			myline.setAttributeNS(null,"x2",WIDTH-0.8*SET_WIDTH);
			myline.setAttributeNS(null,"y1",i+100);
			myline.setAttributeNS(null,"y2",i+100);
			myline.setAttributeNS(null,"stroke","#808080");
			myline.setAttributeNS(null,"stroke-width",1);
			myline.setAttributeNS(null,"stroke-dasharray","1 1");
			document.getElementById("BLOCKS_VIEW").appendChild(myline);	
		}
	}
	var COUNTER=0;
	for (var i = 0; i < (longest/CONVERSION+250); i=i+10000000/CONVERSION) {
		myline = document.createElementNS(svgNS,"line"); //to create a circle, for rectangle use rectangle
		myline.setAttributeNS(null,"x1",0.8*SET_WIDTH);
		myline.setAttributeNS(null,"x2",WIDTH-0.8*SET_WIDTH);
		myline.setAttributeNS(null,"y1",i+100);
		myline.setAttributeNS(null,"y2",i+100);
		myline.setAttributeNS(null,"stroke","#000000");
		myline.setAttributeNS(null,"stroke-width",1);
		myline.setAttributeNS(null,"stroke-dasharray","1 1");
		 mytext.setAttributeNS(null,"alignment-baseline","middle");
		document.getElementById("BLOCKS_VIEW").appendChild(myline);	
		var mytext = document.createElementNS(svgNS,"text"); 
		mytext.setAttributeNS(null,"x",0.78*SET_WIDTH);
		 mytext.setAttributeNS(null,"y",i+100);
		 mytext.setAttributeNS(null,"font-size","12px");    
		 mytext.setAttributeNS(null,"text-anchor","end");       		 	
		mytext.innerHTML = COUNTER;
		document.getElementById("BLOCKS_VIEW").appendChild(mytext); 
		var mytext = document.createElementNS(svgNS,"text"); 
		mytext.setAttributeNS(null,"x",WIDTH-0.78*SET_WIDTH);
		 mytext.setAttributeNS(null,"y",i+100);
		 mytext.setAttributeNS(null,"alignment-baseline","middle");
		 mytext.setAttributeNS(null,"font-size","12px");    
		mytext.innerHTML = COUNTER;
		document.getElementById("BLOCKS_VIEW").appendChild(mytext);            
		COUNTER=COUNTER+10;
	}
	}





// Draw Chromsomes
	var tracker=1;
	// Loop over Chromosomes
	for (var i = 0; i < Chromosomes.length; i++) {
	
// 		Write the Chromosme Title Top.
		var blockText = document.createElementNS(svgNS,"foreignObject"); 
		var headfontsize=SET_WIDTH*Que_Genome.length/(Chromosomes[i].ChrID.length-1);
		headfontsize=parseInt(headfontsize);
		if (headfontsize>25){headfontsize=25;}
		blockText.innerHTML='<div xmlns="http://www.w3.org/1999/xhtml" width='+ SET_WIDTH*Que_Genome.length +' style="text-align:center;font-size:' + headfontsize + 'px; text-transform: uppercase;word-wrap: break-word;color:black;">'+Chromosomes[i].ChrID+'<a/div>';

		blockText.setAttribute('x', tracker*SET_WIDTH);
		blockText.setAttribute('y', 5);
		blockText.setAttribute('width', SET_WIDTH*Que_Genome.length);
		blockText.setAttributeNS(null,"height",25);
		document.getElementById("BLOCKS_VIEW").appendChild(blockText);
// 		Write the Chromosme Title Bottom.
		var blockText = document.createElementNS(svgNS,"foreignObject"); 
		blockText.setAttribute('x', tracker*SET_WIDTH);
		blockText.innerHTML='<div xmlns="http://www.w3.org/1999/xhtml" width='+ SET_WIDTH*Que_Genome.length +' style="text-align:center;font-size:' + headfontsize + 'px; text-transform: uppercase;word-wrap: break-word;color:black;">'+Chromosomes[i].ChrID+'<a/div>';
		blockText.setAttributeNS(null,"height",25);

		blockText.setAttribute('y', (Chromosomes[i].ChrLength/parseInt(CONVERSION))+205);
		blockText.setAttribute('width', SET_WIDTH*Que_Genome.length);
		document.getElementById("BLOCKS_VIEW").appendChild(blockText);


	// Loop over Blocks
		for (var j = 0; j < Que_Genome.length; j++) {

// Write the comparison genomes top
			var allthetext="012345678901234567890123456";
			var genusfound=false;
			Species_details.forEach(function (arrayItem) {
// 						console.log(arrayItem);
			if (arrayItem.Taxid ==Que_Genome[j].substr(1)){
				allthetext=arrayItem.Name;
		 		genusfound=true;
	
				}
	});				
		if (genusfound==false){
			allthetext=Que_Genome[j].substr(1);
		};
// 

	var vartextbits=allthetext.match(/[\s\S]{1,20}/g) || [];
// 	
	var Xposition = tracker*SET_WIDTH;

	for (var m = 0; m < vartextbits.length; m++) {
// 			Top text
	
			if (Xposition<((tracker+1)*SET_WIDTH)-30){
			var Yposition = 50;
			var Boxwidth = SET_WIDTH;
			var Boxheight=60;
			var Rotateval='rotate('+ -20 +','+Xposition+','+Yposition+')';
			var blockText = document.createElementNS(svgNS,"text"); 
			blockText.setAttribute('x', Xposition);
			blockText.setAttribute('y', Yposition+50);
			blockText.setAttribute('width', Boxwidth);
			blockText.setAttributeNS(null,"height",Boxheight);
			blockText.setAttributeNS(null,"transform",Rotateval);
			blockText.innerHTML=vartextbits[m];
			document.getElementById("BLOCKS_VIEW").appendChild(blockText);
			
// 			Bottom text
// 			var blockText = document.createElementNS(svgNS,"text"); 
// 			Yposition =(Chromosomes[i].ChrLength/parseInt(CONVERSION)+110);
// 			 Rotateval='rotate('+ 20 +','+Xposition+','+Yposition+')';
// 			blockText.setAttribute('x', Xposition+20);
// 			blockText.setAttribute('y', Yposition);
// 			blockText.setAttribute('width', Boxwidth);
// 			blockText.setAttributeNS(null,"height",Boxheight);
// 			blockText.setAttributeNS(null,"transform",Rotateval);
// 			blockText.innerHTML=vartextbits[m];
// 			document.getElementById("BLOCKS_VIEW").appendChild(blockText);			
// 
// 			
			
 			Xposition = Xposition+40;
	
	 		}
// 	
// 	
// 	
// 	
	}
	

		
// 		Block_Array
		
			var tester=Chromosomes[i].ChrID + "_" + Que_Genome[j];
			var myChrome = document.createElementNS(svgNS,"rect");  
			myChrome.setAttributeNS(null,"id",tester);
			myChrome.setAttributeNS(null,"x",tracker*SET_WIDTH);
			myChrome.setAttributeNS(null,"width",SET_WIDTH);
			myChrome.setAttributeNS(null,"rx",15);
			myChrome.setAttributeNS(null,"ry",15);
			myChrome.setAttributeNS(null,"stroke","black");
			myChrome.setAttributeNS(null,"stroke-width",2);
			myChrome.setAttributeNS(null,"fill",CHR_COLOR);
//               	myChrome.setAttributeNS(null,"fill-opacity",0.1);
          	
            	var CHRLENGTH=Chromosomes[i].ChrLength/CONVERSION;
				// set it for length
// 				var endpos=250-CHRLENGTH;
	       		 myChrome.setAttributeNS(null,"y",100);
       		 	myChrome.setAttributeNS(null,"height",CHRLENGTH);			
				
				document.getElementById("BLOCKS_VIEW").appendChild(myChrome);
				
				
				
				
				
				
				
				
				
// 				Add select all button; 
		if (SELECT_ALL_BUTTON==true){
				var myChrome = document.createElementNS(svgNS,"rect");  
				 tester=Chromosomes[i].ChrID + "_" + Que_Genome[j].substring(1);
	          	myChrome.setAttributeNS(null,"id",tester);
            	myChrome.setAttributeNS(null,"x",tracker*SET_WIDTH);
            	myChrome.setAttributeNS(null,"width",SET_WIDTH);
            	myChrome.setAttributeNS(null,"rx",15);
            	myChrome.setAttributeNS(null,"ry",15);
            	myChrome.setAttributeNS(null,"stroke","black");
            	myChrome.setAttributeNS(null,"stroke-width",2);
            	myChrome.setAttributeNS(null,"fill","yellow");
            	myChrome.setAttributeNS(null,"y",CHRLENGTH+240);
				myChrome.setAttributeNS(null,"height",90);
				myChrome.onclick = function(){
					var a = document.getElementById(this.id);
					for (var z = 0; z < Block_Array.length; z++) {
						console.log("a"+ a.id+"blk"+Block_Array[z]);
						if(Block_Array[z]==a.id){
							console.log(SELECT_ALL_THING[z]);
							var runtrhough=SELECT_ALL_THING[z].split(/XXXXXX/g) || [];
							var track=true;
							for (var y = 0; y < runtrhough.length; y++) {
								if (Selected.includes(runtrhough[y])){
								}else{
									track=false;
									
									Selected.push(runtrhough[y]);
								}
							
							}
							
							
							if (track==true){
								for (var y = 0; y < runtrhough.length; y++) {
									var index = Selected.indexOf(runtrhough[y]);
									Selected.splice(index, 1); 
								}

							
							}
								          				

							
						}
	
		
		
					}

					make_SVG();
				}
// 					

// 				Add Select all text
				if(SET_WIDTH>49){
					var blockText = document.createElementNS(svgNS,"foreignObject"); 
					var textsize=LABEL_FONT_SIZE;
					if (LABEL_FONT_SIZE=="Responsive"){
						textsize=SET_WIDTH/5;
						textsize=parseInt(textsize);
						if (textsize>16){
							textsize=16
					};
				}	
				if (LABEL_SHADOW==true){
				blockText.innerHTML='<div xmlns="http://www.w3.org/1999/xhtml" width='+ SET_WIDTH +' style="text-align:center;font-size:' + textsize + 'px; text-transform: uppercase;word-wrap: break-word;color:'+LABEL_COLOR+';text-shadow: -1px 1px 0 #000,1px 1px 0 #000,1px -1px 0 #000;-1px -1px 0 #000;">SELECT ALL</div>';
				
				}else{
				
				blockText.innerHTML='<div xmlns="http://www.w3.org/1999/xhtml" width='+ SET_WIDTH +' style="text-align:center;font-size:' + textsize + 'px; text-transform: uppercase;word-wrap: break-word;color:'+LABEL_COLOR+';">SELECT ALL<a/div>';
				}
				
				
				
				blockText.setAttribute('x', tracker*SET_WIDTH);
				blockText.setAttribute('y', CHRLENGTH+270);
				blockText.setAttribute('width', SET_WIDTH);
				blockText.setAttributeNS(null,"height",90);
				blockText.setAttributeNS(null,"style","pointer-events: none;");

			}

// #####################
// ##################### ADD onclick
// #####################				
				
				
				document.getElementById("BLOCKS_VIEW").appendChild(myChrome);
				if(SET_WIDTH>49){
					document.getElementById("BLOCKS_VIEW").appendChild(blockText);
					}
				}
				
// 				Create the tracker array
				Block_Array[tracker]=Chromosomes[i].ChrID + "_" + Que_Genome[j].substring(1);
				// console.log(Block_Array);
	tracker=tracker+1;
			}

	tracker=tracker+1;

		}
// ##############DRAW BLOCKS HERE

	for (var i = 0; i < Blocks.length; i++) {
			var CHR_NUMB=0;
			var CHR_LENTH=0;
			for (var k = 0; k < Chromosomes.length; k++) {
				if (Chromosomes[k].ChrID == Blocks[i].RefChr){
					CHR_NUMB=k;
					CHR_LENTH=Chromosomes[k].ChrLength;
				}
			}
		var tester=Blocks[i].RefChr + "__" + Blocks[i].QueChr + "__" + Blocks[i].RefStart + "__" + Blocks[i].RefEnd + "__" + CHR_LENTH+ "__" +  Blocks[i].Qid+ "__" +  Blocks[i].QueStart+ "__" +  Blocks[i].QueEnd+ "__" +  Blocks[i].Direction+ "__" +  Genome_Name;
		var myBlock = document.createElementNS(svgNS,"rect");  
//		
		var chrstring=Blocks[i].RefChr+"_"+Blocks[i].Qid;
		for (var z = 0; z < Block_Array.length; z++) {
			if(Block_Array[z]==chrstring){
				var newstring="XXXXXX"+tester;
				SELECT_ALL_THING[z]=SELECT_ALL_THING[z]+newstring;
//  			console.log(SELECT_ALL_THING[z]);
			
			}
		}

		
		
	        myBlock.setAttributeNS(null,"id",tester);
// 	        See where it belongs
// 		Get Chr position

// 			console.log(Que_Genome.indexOf(Blocks[i].Que_Genome))
			var widthval=((CHR_NUMB*(Que_Genome.length+1))+Que_Genome.indexOf("Q" + Blocks[i].Qid)+1);
            myBlock.setAttributeNS(null,"x",widthval*SET_WIDTH);
            myBlock.setAttributeNS(null,"width",SET_WIDTH);
            	myBlock.setAttributeNS(null,"rx",2);
            	myBlock.setAttributeNS(null,"ry",2);
            myBlock.setAttributeNS(null,"stroke","black");
            myBlock.setAttributeNS(null,"stroke-width",1);
            if (Selected.includes(tester)){
           		 if(Blocks[i].Direction=="+1"){
            		myBlock.setAttributeNS(null,"fill",FORWARD_HIGHLIGHT);
           		 }else{
            		myBlock.setAttributeNS(null,"fill",REVERSE_HIGHLIGHT);
            	}      
            }else if(Blocks[i].Direction=="+1"){
            	myBlock.setAttributeNS(null,"fill",FORWARD_COLOR);
            }else{
            	myBlock.setAttributeNS(null,"fill",REVERSE_COLOR);
            }          	
            	var CHRLENGTH=(Blocks[i].RefEnd-Blocks[i].RefStart)/CONVERSION;
				// set it for length
// 				var endpos=250-CHRLENGTH;
	       	myBlock.setAttributeNS(null,"y",(Blocks[i].RefStart/CONVERSION)+100);
       		myBlock.setAttributeNS(null,"height",CHRLENGTH);
//        		ADD Text labels
			var textsize=LABEL_FONT_SIZE;
			if(CHRLENGTH>20){
				var blockText = document.createElementNS(svgNS,"foreignObject"); 
				var textsize=LABEL_FONT_SIZE;
				if (LABEL_FONT_SIZE=="Responsive"){
					textsize=SET_WIDTH/5;
					textsize=parseInt(textsize);
					if (textsize>16){
						textsize=16
					};
				}	
				if (LABEL_SHADOW==true){
				blockText.innerHTML='<div xmlns="http://www.w3.org/1999/xhtml" width='+ SET_WIDTH +' style="text-align:center;font-size:' + textsize + 'px; text-transform: uppercase;word-wrap: break-word;color:'+LABEL_COLOR+';text-shadow: -1px 1px 0 #000,1px 1px 0 #000,1px -1px 0 #000;-1px -1px 0 #000;">'+Blocks[i].QueChr+'</div>';
				
				}else{
				
				blockText.innerHTML='<div xmlns="http://www.w3.org/1999/xhtml" width='+ SET_WIDTH +' style="text-align:center;font-size:' + textsize + 'px; text-transform: uppercase;word-wrap: break-word;color:'+LABEL_COLOR+';">'+Blocks[i].QueChr+'<a/div>';
				}
				
				
				
				blockText.setAttribute('x', widthval*SET_WIDTH);
				blockText.setAttribute('y', (Blocks[i].RefStart/CONVERSION)+100);
				blockText.setAttribute('width', SET_WIDTH);
				blockText.setAttributeNS(null,"height",CHRLENGTH);
				blockText.setAttributeNS(null,"style","pointer-events: none;");
			}
       		
//        		ON CLICK FUNCTION
			myBlock.onclick = function(){
				var a = document.getElementById(this.id);
				if (Selected.includes(a.id)){
					var index = Selected.indexOf(a.id);
 					Selected.splice(index, 1);     				
				}else{
					Selected.push(a.id)
				}

				make_SVG();
			}

// ON HOVER FUNCTION
       		
       		myBlock.onmouseenter= function(e) {
       			var supertester = document.getElementById("temp");
       			if (supertester){
       			}else{
		  			var x = e.clientX;
		  			var y = e.clientY;
					var svgP = svgPoint(myBlock, x, y);
   					var mytemp = document.createElementNS(svgNS, 'rect');
  					mytemp.setAttributeNS(null, 'id', "temp");   		
  					mytemp.setAttributeNS(null,"x",svgP.x);
  					mytemp.setAttributeNS(null,"width",400);
  					mytemp.setAttributeNS(null,"y",svgP.y);
    				mytemp.setAttributeNS(null,"height",220);
            		mytemp.setAttributeNS(null,"rx",20);
            		mytemp.setAttributeNS(null,"ry",20);
            		mytemp.setAttributeNS(null,"stroke","black");
					mytemp.setAttributeNS(null,"stroke-width",1);
					mytemp.setAttributeNS(null,"fill","white");
  					document.getElementById("BLOCKS_VIEW").appendChild(mytemp);

					var mytemptext = document.createElementNS(svgNS,"text"); 
					var xcoord=svgP.x+20;
					mytemptext.setAttributeNS(null, 'id', "temptext");   		
					mytemptext.setAttributeNS(null,"x",xcoord);
					mytemptext.setAttributeNS(null,"y",svgP.y+20);
					mytemptext.setAttributeNS(null,"font-size","12px");
		
// 					test if the id for the query genome is found in the database.
					var tempor = this.id;
					var tempstorage=tempor.split('__');
// If not only list REFRENCE\tCHR\n \Total Length Start\nStop\nQuery Start\Stop
// 					console.log(tempstorage);
					var REFOUND=false;;
					var QUERYFOUND=false;
// 					console.log(Species_details);
					Species_details.forEach(function (arrayItem) {
// 						console.log(arrayItem);
					if (arrayItem.Taxid ==Genome_Name){
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan font-weight="bold">'+"Reference: "+arrayItem.Common_Name+'</tspan>';
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan dy="1em" x="'+xcoord+'">'+"Reference Genome: "+arrayItem.Name + "   "+arrayItem.Assembly+'</tspan>';
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan dy="1em" x="'+xcoord+'">'+"Reference taxID: "+Genome_Name +'</tspan>';
						REFOUND=true;
						}else if (arrayItem.Taxid == tempstorage[5]){
	
						}
					});					
					if (REFOUND==false){
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan font-weight="bold" dy="1em" x="'+xcoord+'">'+"Reference Genome: "+Genome_Name +'</tspan>';
					}
					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Reference Chromsome: "+tempstorage[0] +'</tspan>';
					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Reference Start: "+tempstorage[2] +'</tspan>';
					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Reference End: "+tempstorage[3] +'</tspan>';					
					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Reference Chromosome Length: "+Math.round(tempstorage[4]/1000000) +"mbp"+'</tspan>';

					Species_details.forEach(function (arrayItem) {
// 						console.log(arrayItem);
					if (arrayItem.Taxid ==tempstorage[5]){
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan font-weight="bold" dy="1em" x="'+xcoord+'">'+"Query: " + arrayItem.Common_Name+'</tspan>';
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan dy="1em" x="'+xcoord+'">'+"Query Genome: "+arrayItem.Name + "   "+arrayItem.Assembly+'</tspan>';
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan dy="1em" x="'+xcoord+'">'+"Query taxID: "+tempstorage[5] +'</tspan>';
						QUERYFOUND=true;
						}
					});					
					if (QUERYFOUND==false){
						mytemptext.innerHTML = mytemptext.innerHTML+ '<tspan font-weight="bold" dy="1em" x="'+xcoord+'">'+"Query Genome: "+tempstorage[5] +'</tspan>';
					}

					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Query Chromosome: "+tempstorage[1] +'</tspan>';
					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Query Start: "+tempstorage[6] +'</tspan>';
					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Query End: "+tempstorage[7] +'</tspan>';
// ##############################################################					
// 					SLOWS IT RIGHT THE FUCK DOWN. NOT WORTH THE EFFORT OF OPTIMIZATION
// 					var tempchrome;
// 					Blocks_DB.forEach(function (arrayItem) {
// 						if(arrayItem.Taxid==tempstorage[5]){
//    							tempchrome=arrayItem.Chromosomes;
// 						}
// 					});
// 					tempchrome.forEach(function (arrayItem) {
// 					if (arrayItem.ChrID==tempstorage[1])
// 					mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+"Query Chromosome Length: "+Math.round(arrayItem.ChrLength/1000000) +"mbp"+'</tspan>';
// 						});
// ##############################################################
					
					if (tempstorage[8]==-1){
								mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+'Direction: -</tspan>';
		
					}else{
								mytemptext.innerHTML = mytemptext.innerHTML +'<tspan dy="1em" x="'+xcoord+'">'+'Direction: +</tspan>';

					}					

					
					
					document.getElementById("BLOCKS_VIEW").appendChild(mytemptext);



  				}
			};


       		myBlock.onmouseleave = function(){
				var c = document.getElementById("temptext");
				c.remove();       		
				var b = document.getElementById("temp");
				b.remove();
       		}       		
       		
			document.getElementById("BLOCKS_VIEW").appendChild(myBlock);
			if(CHRLENGTH>20){
				document.getElementById("BLOCKS_VIEW").appendChild(blockText);
			}
			
	}
// 	Draw the selected here
	CSV_output="";

	var outputarea = document.getElementById("SELECTED_BLOCKS");
	var full_list = "SELECTED BLOCKS:REF GENOME, REF CHROMOSOME, REF START,REF END, QUERY START, QUERY END, DIRECTION, QUERY GENOME, QUERY CHROMOSOME"+ "<br>";
	for(var L=0; L<Selected.length; ++L){
			tempstorage=Selected[L].split('__');
			console.log(tempstorage);
		if(tempstorage[1] != undefined){
// 		9913,chr1,145018424,145644834,7366807,7825527,ScFKYPt_128144_HRSCAF=131517b

			full_list = full_list +tempstorage[9]+","+tempstorage[0]+","+tempstorage[2]+","+tempstorage[3]+","+tempstorage[6]+","+tempstorage[7]+","+tempstorage[8]+","+tempstorage[5]+","+tempstorage[1]+"<br>";
			CSV_output=CSV_output +tempstorage[9]+","+tempstorage[0]+","+tempstorage[2]+","+tempstorage[3]+","+tempstorage[6]+","+tempstorage[7]+","+tempstorage[8]+","+tempstorage[5]+","+tempstorage[1]+"\n";
		}
	} 
	outputarea.innerHTML=full_list;
	
};
// output function for csv
function save_csv(){
    var hiddenElement = document.createElement('a');
    hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(CSV_output);
    hiddenElement.target = '_blank';
    hiddenElement.download = 'data.csv';
    hiddenElement.click();

}
</script>

   </body>
</html>